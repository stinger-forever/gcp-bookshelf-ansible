- name: First Play
  hosts: localhost
  become: yes
  become_user: root
#  vars:
#    var1: value
#  vars_files:
#    - var-file.txt
  tasks:
    - name: setup dependencies
      apt:
        update_cache: yes
        name:
          - wget
          - supervisor
          - python
          - python3-pip
          - python3-pymysql

    - name: pip setup part
      pip:
        name:
          - pip
          - virtualenv
        extra_args: --upgrade

    - name: Add the user 'pythonapp' for app
      user:
        name: pythonapp
        home: /home/pythonapp
        state: present

    - name: export variable
      shell: "export HOME=/root"

    - name: clone the project
      git:
        repo: https://github.com/GoogleCloudPlatform/getting-started-python.git
        dest: /opt/app
        clone: yes
        accept_hostkey: yes

    - name: execute script to fast-forward
      shell: |
        pip3 install Flask Flask-SQLAlchemy
        cp -r /opt/playbooks/7-gce/* /opt/app/
        # Python environment setup
        virtualenv -p python3 /opt/app/gce/env
        source /opt/app/gce/env/bin/activate
        /opt/app/gce/env/bin/pip install -r /opt/app/gce/requirements.txt

        # Set ownership to newly created account
        chown -R pythonapp:pythonapp /opt/app

        # Put supervisor configuration in proper place
        cp /opt/app/gce/python-app.conf /etc/supervisor/conf.d/python-app.conf

        wget https://dl.google.com/cloudsql/cloud_sql_proxy.linux.amd64 -O /usr/local/bin/cloud_sql_proxy
        chmod +x /usr/local/bin/cloud_sql_proxy

        #sudo cloud_sql_proxy -instances=osdu-deploy-gasparyan:europe-west1:bookshelf-dbase=tcp:3306

        echo "
        [Unit]
        Description=Connecting MySQL Client from Compute Engine using the Cloud SQL Proxy
        Documentation=https://cloud.google.com/sql/docs/mysql/connect-compute-engine
        Requires=networking.service
        After=networking.service

        [Service]
        WorkingDirectory=/usr/local/bin
        ExecStart=/usr/local/bin/cloud_sql_proxy -dir=/var/run/cloud-sql-proxy -instances=osdu-deploy-gasparyan:europe-west1:bookshelf-dbase=tcp:3306
        Restart=always
        StandardOutput=journal
        User=root

        [Install]
        WantedBy=multi-user.target
        " > /etc/systemd/system/cloud-sql-proxy.service
        sudo systemctl daemon-reload
        sudo systemctl enable cloud-sql-proxy
        sudo systemctl start cloud-sql-proxy
        cd /opt/app
        python3 bookshelf/model_cloudsql.py

        # Start service via supervisorctl
        sudo supervisorctl reread
        sudo supervisorctl update

#    - name: change script permission
#      file:
#        dest=/opt/playbooks/start.sh
#        mode=+x
#
#    - name: fastforward-script
#      command: bash /opt/playbooks/start.sh


#  handlers:
#  - name: some_name
#    service: name=service_name state=running or restarted
